---
import Footer from '../components/Footer.astro';
import Menu from '../components/Menu.astro';

interface Props {
	title?: string;
	description?: string;
}

const { 
	title = "Triverse-3.0",
	description = ""
} = Astro.props;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/png" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="generator" content={Astro.generator} />
		<meta name="description" content={description} />
		<title>{title}</title>
		
        <!-- GSAP Core & ScrollTrigger -->
		<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js" defer></script>
        <!-- ScrollSmoother (Trial - for demonstration) -->
        <script src="https://assets.codepen.io/16327/ScrollSmoother.min.js" defer></script>
		
        <!-- Lenis (Fallback/Alternative) -->
		<script src="https://cdn.jsdelivr.net/gh/studio-freight/lenis@1.0.29/bundled/lenis.min.js" defer></script>
        
        <style>
            /* Critical styles for the reveal effect */
            body {
                margin: 0;
                padding: 0;
                background-color: #000; /* Match footer bg */
            }
            
            #smooth-wrapper {
                overflow: hidden;
                position: relative;
                width: 100%;
                z-index: 2; /* Above footer initially */
                pointer-events: none;
            }
            
            .content-wrapper {
                position: relative;
                z-index: 2;
                background-color: #010418; /* Ensure content has background to cover footer */
                width: 100%;
                will-change: transform;
                pointer-events: auto;
            }

            .footer-spacer {
                height: 100vh; /* Will be updated by JS */
                width: 100%;
                pointer-events: none;
                visibility: hidden;
            }
        </style>
	</head>
	<body>
        <Menu />
        
        <div id="smooth-wrapper">
            <div id="smooth-content">
                <div class="content-wrapper">
                    <slot />
                </div>
                <!-- Spacer to allow scrolling "past" the content to reveal fixed footer -->
                <div class="footer-spacer"></div>
            </div>
        </div>
        
		<Footer />
		
		<script is:inline>
			document.addEventListener("DOMContentLoaded", () => {
                // Wait for GSAP and plugins to load
                const checkDependencies = setInterval(() => {
                    if (window.gsap && window.ScrollTrigger) {
                        clearInterval(checkDependencies);
                        initApp();
                    }
                }, 100);

                function initApp() {
                    gsap.registerPlugin(ScrollTrigger);
                    
                    // Check if ScrollSmoother is available (it's a paid plugin, using trial URL)
                    const hasScrollSmoother = window.ScrollSmoother;
                    
                    if (hasScrollSmoother) {
                        // Use ScrollSmoother if available
                        ScrollSmoother.create({
                            wrapper: "#smooth-wrapper",
                            content: "#smooth-content",
                            smooth: 3,
                            effects: true,
                            smoothTouch: 0.1,
                            normalizeScroll: true
                        });
                    } else {
                        // Fallback to Lenis if ScrollSmoother fails to load (e.g. trial restrictions)
                        initLenis();
                    }

                    // Handle Footer Reveal Logic
                    handleFooterReveal();
                    
                    // Initialize other animations
                    initParallax();
                }

                function handleFooterReveal() {
                    const footer = document.querySelector('.footer');
                    const spacer = document.querySelector('.footer-spacer');
                    const contentWrapper = document.querySelector('.content-wrapper');

                    if (!footer || !spacer) return;

                    // Update spacer height to match footer height
                    function updateFooterHeight() {
                        const height = footer.offsetHeight;
                        spacer.style.height = `${height}px`;
                    }

                    // Initial set
                    updateFooterHeight();
                    
                    // Update on resize
                    window.addEventListener('resize', updateFooterHeight);
                    
                    // Optional: Add the specific GSAP animation requested by user
                    // This creates a parallax effect where the content slides up slightly faster
                    // or just ensures the reveal is smooth.
                    // Since we are using the "fixed footer + spacer" technique, the reveal is natural.
                    // However, we can enhance it with ScrollTrigger.
                    
                    ScrollTrigger.create({
                        trigger: spacer,
                        start: "top bottom", // When top of spacer hits bottom of viewport
                        end: "bottom bottom", // When bottom of spacer hits bottom of viewport
                        scrub: true,
                        // markers: true,
                        onUpdate: (self) => {
                            // Optional: Parallax the footer content
                            // gsap.to(footer.children, { y: (1 - self.progress) * -50, ease: "none", overwrite: true });
                        }
                    });
                }

                function initLenis() {
                    if (typeof window === 'undefined' || !window.Lenis) return;
					
					const lenis = new Lenis({
						duration: 1.5, // Increased for "smooth: 3" feel
						easing: (t) => Math.min(1, 1.001 - Math.pow(2, -10 * t)),
						direction: 'vertical',
						gestureDirection: 'vertical',
						smooth: true,
						smoothTouch: true,
						touchMultiplier: 2,
					});
					
					function raf(time) {
						lenis.raf(time);
						requestAnimationFrame(raf);
					}
					requestAnimationFrame(raf);
                    
                    // Sync with ScrollTrigger
                    lenis.on('scroll', ScrollTrigger.update);
                    gsap.ticker.add((time) => {
                        lenis.raf(time * 1000);
                    });
                    gsap.ticker.lagSmoothing(0);
                }

                function initParallax() {
                    const scrollElements = document.querySelectorAll('[data-scroll]');
					scrollElements.forEach((element) => {
						const speed = parseFloat(element.getAttribute('data-scroll-speed')) || 0.5;
						gsap.to(element, {
							y: () => window.innerHeight * speed * 0.3,
							ease: 'none',
							scrollTrigger: {
								trigger: element,
								start: 'top bottom',
								end: 'bottom top',
								scrub: true
							}
						});
					});
                }
            });
		</script>
	</body>
</html>
